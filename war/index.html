<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Hack the Hearst 2014</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link rel="stylesheet" href="css/microphone.css">
<style type="text/css">
body,
html {
	font-family: arial, sans-serif;
	color: #333;
	margin: 3px 8px 2em;
	padding: 0;
	background: #FFF;
}

#main {
	clear: both;
	text-align: center;
	vertical-align: middle;
	margin-left: auto;
	margin-right: auto;
	height: 87%;
}

#content {
	padding-top: 1.5em;
	margin:0 auto;
}

#trademark {
	color: #FF0000;
	font-weight: bold;
	font-size: 24px;
}

#info {    
    text-align: center;
    color: #777;
    visibility: hidden;
}

#q {
  margin-left: 8px;
  height: 24px;
}

#q:focus { 
	border: solid 1px blue; 
}

#result-container {
    margin-left: 48px;
    margin-right: 48px;
    margin-top: 24px;
    visibility: hidden;
    height: auto;
}

.search_form {
    display: inline-block;
    border: 1px inset #ccc;
}

.search_form input {
    border: none;
    padding: 0;
    vertical-align: middle;
}

.search_form button {
    border: none;
    background: none;
    vertical-align: middle;
}

.top-spacer { 
	margin-top:20px; 
}

/* Pretty print JSON */
pre {
	background-color: #FDF6E3;
	border: 1px solid #93A1A1;
	padding: 0;
	margin: 0;
	text-align: left;	
}

pre > code {
	white-space: pre;  
  display: block;
}

.string {
	color: #586E75;
}

.number {
	color: #CB4B16;
}

.boolean {
	color: #268BD2;
}

.null {
	color: #D33682;
}

.key {
	color: #DC322F;
}
/* Pretty print JSON */
</style>
</head>

<body>
  <div id="header">
    <div id="trademark">Wacka Wacka</div>
	</div>

<div class="container" id="main">	
	<div class="row">
		<div class="col-md-12">
			<form class="search_form">
      			<input type="text" id="q" size="56" />
      			<button type="button">
					<img id="microphone" src="images/mic.gif" alt="Search" width="32" height="32"/>
				</button>       		     
    		</form>    
    		<button type="button" id="do-search" class="btn btn-default">Go</button>
		</div>
		<div id="info"></div>
	</div>     	
  
 	<div class="row top-spacer">
 		<div class="col-md-12">
 			<pre id="result-container"><code id="result"></code></pre>
 		</div>
 	</div>  
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="js/microphone.js"></script>
<script>
var mic = new Wit.Microphone(document.getElementById("microphone"));
var info = function (msg) {
  document.getElementById("info").innerHTML = msg;
};
mic.onready = function () {
  info("Microphone is ready to record");
};
mic.onaudiostart = function () {
  info("Recording started");
};
mic.onaudioend = function () {
  info("Recording stopped, processing started");
};
mic.onerror = function (err) {
  info("Error: " + err);
};
mic.onresult = function (intent, entities) {
  var result = kv("intent", intent);
  for (var k in entities) {
    var e = entities[k];
    if (!(e instanceof Array)) {
    	result += kv(k, e.value);
    } else {
      for (var i = 0; i < e.length; i++) {
    	  result += kv(k, e[i].value);
      }
    }
  }
  
  $.ajax({
		data : { 
			intent: result
		},
		success: function(data) {						
			$('#result').html(syntaxHighlight(data));
			$('#result').css('visibility', 'visible');
		},
		error: function(xhr, status, error) {
			$('#result').html(syntaxHighlight(xhr.responseText));
			$('#result-container').css('visibility', 'visible');
		},
		type: 'POST',
		url: '/search'
	});  
};
mic.connect("GCZJCLN3C4A472BHYLCAFSF7UTLYPHBX");
// mic.start();
// mic.stop();

function kv (k, v) {
	if (toString.call(v) !== "[object String]") {
    	v = JSON.stringify(v);
  	}
  	return k + "=" + v + "\n";
}

function syntaxHighlight(json) {
    if (typeof json != 'string') {
         json = JSON.stringify(json, undefined, 2);
    }
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'key';
            } else {
                cls = 'string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'boolean';
        } else if (/null/.test(match)) {
            cls = 'null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}

$("#do-search").click(function() {
	$.ajax({
		data : { 
			q: $('#q').val()
		},
		success : function(data) {						
			$('#result').html(syntaxHighlight(data));
			$('#result-container').css('visibility', 'visible');
		},
		error : function(xhr, status, error) {
			$('#result').html(syntaxHighlight(xhr.responseText));
			$('#result-container').css('visibility', 'visible');
		},
		type : 'POST',
		url : '/search'
	});
});
</script>
</body>

<script>
</script>

</html>